# ë³´ì•ˆ ì—…ë°ì´íŠ¸ ë° ì˜ì¡´ì„± ê´€ë¦¬ ì›Œí¬í”Œë¡œìš°
name: Security Updates

on:
  schedule:
    # ë§¤ì£¼ ì›”ìš”ì¼ ì˜¤ì „ 9ì‹œ (UTC)
    - cron: '0 9 * * 1'
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥
  push:
    paths:
      - 'package.json'
      - 'yarn.lock'
      - '**/package.json'

permissions:
  contents: write
  pull-requests: write
  security-events: write

env:
  NODE_VERSION: '18'

jobs:
  # ë³´ì•ˆ ì·¨ì•½ì  ìŠ¤ìº”
  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest
    outputs:
      vulnerabilities-found: ${{ steps.audit.outputs.vulnerabilities }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'yarn'

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Run security audit
        id: audit
        run: |
          # npm audit ì‹¤í–‰ ë° ê²°ê³¼ ì €ì¥
          if yarn audit --level high --json > audit-results.json; then
            echo "vulnerabilities=false" >> $GITHUB_OUTPUT
          else
            echo "vulnerabilities=true" >> $GITHUB_OUTPUT
            echo "::warning::High severity vulnerabilities found"
          fi

      - name: Upload audit results
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: audit-results
          path: audit-results.json

      - name: Run Trivy scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

  # ìë™ ì˜ì¡´ì„± ì—…ë°ì´íŠ¸
  dependency-updates:
    name: Update Dependencies
    runs-on: ubuntu-latest
    needs: security-audit
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    strategy:
      matrix:
        update-type: [patch, minor]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'yarn'

      - name: Configure Git
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

      - name: Update patch dependencies
        if: matrix.update-type == 'patch'
        run: |
          yarn upgrade --pattern '*' --latest
          git add .
          if ! git diff --staged --quiet; then
            git commit -m "chore: update patch dependencies"
            git push origin HEAD:dependency-updates/patch-$(date +%Y%m%d)
          fi

      - name: Update minor dependencies
        if: matrix.update-type == 'minor'
        run: |
          # ë§ˆì´ë„ˆ ì—…ë°ì´íŠ¸ëŠ” ë” ì‹ ì¤‘í•˜ê²Œ ì²˜ë¦¬
          yarn outdated --json > outdated.json || true
          
          # ì¤‘ìš”í•˜ì§€ ì•Šì€ íŒ¨í‚¤ì§€ë§Œ ì—…ë°ì´íŠ¸
          yarn upgrade --pattern '@types/*' --latest
          yarn upgrade --pattern 'eslint*' --latest
          yarn upgrade --pattern 'prettier*' --latest
          
          git add .
          if ! git diff --staged --quiet; then
            git commit -m "chore: update minor dependencies (types, linting)"
            git push origin HEAD:dependency-updates/minor-$(date +%Y%m%d)
          fi

  # Dependabot PR ìë™ ë³‘í•©
  auto-merge-dependabot:
    name: Auto-merge Dependabot PRs
    runs-on: ubuntu-latest
    if: github.actor == 'dependabot[bot]'
    
    steps:
      - name: Dependabot metadata
        id: metadata
        uses: dependabot/fetch-metadata@v1
        with:
          github-token: "${{ secrets.GITHUB_TOKEN }}"

      - name: Auto-merge patch updates
        if: steps.metadata.outputs.update-type == 'version-update:semver-patch'
        run: |
          gh pr review --approve "$PR_URL"
          gh pr merge --auto --squash "$PR_URL"
        env:
          PR_URL: ${{github.event.pull_request.html_url}}
          GITHUB_TOKEN: ${{secrets.GITHUB_TOKEN}}

      - name: Auto-approve minor updates
        if: steps.metadata.outputs.update-type == 'version-update:semver-minor'
        run: |
          gh pr review --approve "$PR_URL"
          # ë§ˆì´ë„ˆ ì—…ë°ì´íŠ¸ëŠ” ìŠ¹ì¸ë§Œ í•˜ê³  ìˆ˜ë™ ë³‘í•© ëŒ€ê¸°
        env:
          PR_URL: ${{github.event.pull_request.html_url}}
          GITHUB_TOKEN: ${{secrets.GITHUB_TOKEN}}

  # ë¼ì´ì„¼ìŠ¤ ì²´í¬
  license-check:
    name: License Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'yarn'

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Install license checker
        run: npm install -g license-checker

      - name: Check licenses
        run: |
          license-checker --onlyAllow 'MIT;Apache-2.0;BSD-2-Clause;BSD-3-Clause;ISC;0BSD' \
            --excludePrivatePackages \
            --summary > license-summary.txt

      - name: Upload license summary
        uses: actions/upload-artifact@v3
        with:
          name: license-summary
          path: license-summary.txt

  # ë³´ì•ˆ ì´ìŠˆ ì•Œë¦¼
  notify-security-issues:
    name: Notify Security Issues
    runs-on: ubuntu-latest
    needs: [security-audit]
    if: needs.security-audit.outputs.vulnerabilities-found == 'true'
    
    steps:
      - name: Send Slack notification
        uses: 8398a7/action-slack@v3
        with:
          status: custom
          custom_payload: |
            {
              "text": "ğŸš¨ Security vulnerabilities detected in delivery platform",
              "attachments": [
                {
                  "color": "danger",
                  "fields": [
                    {
                      "title": "Repository",
                      "value": "${{ github.repository }}",
                      "short": true
                    },
                    {
                      "title": "Branch",
                      "value": "${{ github.ref }}",
                      "short": true
                    },
                    {
                      "title": "Action",
                      "value": "Please review and update vulnerable dependencies",
                      "short": false
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Create security issue
        uses: actions/github-script@v7
        with:
          script: |
            const title = 'ğŸš¨ Security vulnerabilities detected';
            const body = `
            ## Security Audit Results
            
            High severity vulnerabilities have been detected in the project dependencies.
            
            ### Next Steps
            1. Review the audit results in the [Security tab](https://github.com/${{ github.repository }}/security)
            2. Update vulnerable dependencies
            3. Test the application after updates
            4. Create a security patch release if needed
            
            ### Audit Command
            \`\`\`bash
            yarn audit --level high
            \`\`\`
            
            This issue was automatically created by the security workflow.
            `;
            
            // ê¸°ì¡´ ë³´ì•ˆ ì´ìŠˆê°€ ìˆëŠ”ì§€ í™•ì¸
            const existingIssues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'security',
              state: 'open'
            });
            
            if (existingIssues.data.length === 0) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['security', 'high-priority']
              });
            }

  # ì½”ë“œ í’ˆì§ˆ ë¦¬í¬íŠ¸
  quality-report:
    name: Generate Quality Report
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'yarn'

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Generate bundle analysis
        run: |
          # ì›¹ ì•± ë²ˆë“¤ ë¶„ì„
          cd apps/web
          npm install -g @next/bundle-analyzer
          ANALYZE=true yarn build

      - name: Run complexity analysis
        run: |
          # ì½”ë“œ ë³µì¡ë„ ë¶„ì„
          npx ts-node scripts/analyze-complexity.ts > complexity-report.md

      - name: Upload reports
        uses: actions/upload-artifact@v3
        with:
          name: quality-reports
          path: |
            complexity-report.md
            apps/web/.next/analyze/

  # í™˜ê²½ë³„ í™˜ê²½ ë³€ìˆ˜ ê²€ì¦
  validate-env-vars:
    name: Validate Environment Variables
    runs-on: ubuntu-latest
    strategy:
      matrix:
        environment: [development, staging, production]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate environment configuration
        run: |
          # ê° í™˜ê²½ë³„ í•„ìˆ˜ í™˜ê²½ ë³€ìˆ˜ ì²´í¬
          echo "Validating ${{ matrix.environment }} environment variables..."
          
          # .env.exampleì„ ê¸°ë°˜ìœ¼ë¡œ ê²€ì¦
          if [ -f ".env.example" ]; then
            while IFS= read -r line || [[ -n "$line" ]]; do
              if [[ $line == *"="* ]] && [[ $line != "#"* ]]; then
                var_name=$(echo $line | cut -d'=' -f1)
                echo "Checking required variable: $var_name"
              fi
            done < .env.example
          fi 